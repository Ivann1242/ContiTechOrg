<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员仪表板 - CONTI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .nav-tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        .nav-tab {
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .nav-tab.active {
            background-color: #007bff;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-warning {
            background-color: #ffc107;
            color: black;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .news-list, .positions-list {
            margin-top: 30px;
        }
        .news-item, .position-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .news-item-header, .position-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .news-actions, .position-actions {
            display: flex;
            gap: 10px;
        }
        .hidden {
            display: none;
        }
        #message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .image-preview {
            max-width: 300px;
            margin: 10px 0;
        }
        .image-preview img {
            max-width: 100%;
            height: auto;
        }
        .current-image {
            margin: 10px 0;
        }
        .current-image img {
            max-width: 200px;
            height: auto;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal-content {
            background: white;
            margin: 2% auto;
            padding: 20px;
            width: 90%;
            max-width: 800px;
            border-radius: 8px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        .close {
            position: absolute;
            right: 10px;
            top: 10px;
            font-size: 24px;
            cursor: pointer;
        }
        /* 项目管理相关样式 */
        .content-editor {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .editor-toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .editor-toolbar button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background: var(--primary-color);
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .editor-toolbar button:hover {
            background: #1557b0;
        }
        .editor-blocks {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .content-block {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: white;
            position: relative;
        }
        .content-block.selected {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(26,115,232,0.2);
        }
        .content-block textarea {
            width: 100%;
            min-height: 100px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px;
            resize: vertical;
        }
        .content-block img {
            max-width: 100%;
            height: auto;
        }
        .block-toolbar {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
        }
        .projects-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .project-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .project-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        .project-content {
            padding: 20px;
        }
        .project-category {
            display: inline-block;
            padding: 4px 12px;
            background: var(--hover-color);
            color: var(--primary-color);
            border-radius: 16px;
            font-size: 0.875rem;
            margin-bottom: 10px;
        }
        .project-status {
            display: inline-block;
            padding: 4px 12px;
            background: #e8f5e9;
            color: #2e7d32;
            border-radius: 16px;
            font-size: 0.875rem;
            margin-left: 10px;
        }
        /* 项目管理样式 */
        .project-blocks {
            max-height: calc(70vh - 200px);
            overflow-y: auto;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .project-block {
            margin: 10px 0;
            padding: 15px;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            position: relative;
        }
        .project-block textarea {
            width: 100%;
            min-height: 100px;
            max-height: 500px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px;
            resize: vertical;
            overflow-y: auto;
            line-height: 1.6;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .project-block img {
            max-width: 100%;
            height: auto;
            margin: 10px 0;
        }
        .block-actions {
            margin: 10px 0;
            display: flex;
            gap: 10px;
        }
        .action-button {
            padding: 8px 15px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .action-button:hover {
            background: #e0e0e0;
        }
        .block-controls {
            position: absolute;
            right: 10px;
            top: 10px;
            display: flex;
            gap: 5px;
        }
        .block-control {
            padding: 5px 10px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            color: #666;
        }
        .block-control:hover {
            background: #f0f0f0;
        }
        /* 自定义滚动条样式 */
        .project-blocks::-webkit-scrollbar {
            width: 8px;
        }
        .project-blocks::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .project-blocks::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .project-blocks::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        .project-block textarea:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
            outline: none;
        }
        /* 项目列表样式 */
        .project-item {
            padding: 20px;
            margin: 15px 0;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            position: relative;
            transition: all 0.3s ease;
        }
        .project-item .project-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .project-item .project-info {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            color: #666;
        }
        .project-item .project-actions {
            display: flex;
            gap: 10px;
        }
        .project-actions button {
            padding: 5px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            background: #fff;
        }
        .project-actions button:hover {
            background: #f0f0f0;
        }
        /* 项目图片统一样式 */
        .project-item .project-preview-image {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-radius: 4px;
            margin: 10px 0;
            background-color: #f8f9fa;
        }
        /* 图片上传区域样式 */
        .image-upload-area {
            width: 100%;
            height: 200px;
            border: 2px dashed #ddd;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
            margin-bottom: 10px;
        }
        .image-upload-area:hover {
            border-color: #007bff;
            background: #f0f7ff;
        }
        .image-upload-area i {
            font-size: 48px;
            color: #666;
            margin-bottom: 10px;
        }
        .image-upload-area span {
            color: #666;
            font-size: 14px;
        }
        #projectForm {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
        .form-actions {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 15px 0;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: auto;
        }
        .form-actions button {
            padding: 8px 20px;
            border-radius: 4px;
            cursor: pointer;
        }
        .form-actions .submit-button {
            background: #007bff;
            color: white;
            border: none;
        }
        .form-actions .cancel-button {
            background: #f8f9fa;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>管理员仪表板</h1>
            <button class="btn btn-danger" onclick="logout()">退出登录</button>
        </div>

        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchTab('news')">新闻管理</div>
            <div class="nav-tab" onclick="switchTab('positions')">岗位管理</div>
            <div class="nav-tab" onclick="switchTab('projects')">项目管理</div>
        </div>

        <div id="message" class="hidden"></div>

        <!-- 新闻管理面板 -->
        <div id="newsTab" class="tab-content active">
            <form id="newsForm" enctype="multipart/form-data">
                <input type="hidden" id="editingId" value="">
                <input type="hidden" id="currentImage" value="">
                <div class="form-group">
                    <label for="title">标题</label>
                    <input type="text" id="title" required>
                </div>
                <div class="form-group">
                    <label for="content">内容</label>
                    <textarea id="content" rows="4" required></textarea>
                </div>
                <div class="form-group">
                    <label for="image">图片</label>
                    <input type="file" id="image" accept="image/*" onchange="previewImage(event)">
                    <div id="imagePreview" class="image-preview"></div>
                    <div id="currentImageDisplay" class="current-image"></div>
                </div>
                <button type="submit" class="btn btn-primary" id="submitBtn">发布新闻</button>
                <button type="button" class="btn btn-warning hidden" id="cancelBtn" onclick="cancelEdit()">取消编辑</button>
            </form>

            <div class="news-list" id="newsList">
                <!-- 新闻列表将通过 JavaScript 动态加载 -->
            </div>
        </div>

        <!-- 岗位管理面板 -->
        <div id="positionsTab" class="tab-content">
            <button class="btn btn-primary" onclick="showPositionModal()">
                <i class="fas fa-plus"></i> 添加新岗位
            </button>

            <div class="positions-list" id="positionsList">
                <!-- 岗位列表将通过 JavaScript 动态加载 -->
            </div>
        </div>

        <!-- 项目管理面板 -->
        <div id="projectsTab" class="tab-content" style="display: none;">
            <div class="section-header">
                <h2>项目管理</h2>
                <button class="add-button btn btn-primary" onclick="showAddProjectModal()">
                    <i class="fas fa-plus"></i> 添加新项目
                </button>
            </div>
            <div id="projectsList" class="items-list"></div>
        </div>

        <!-- 岗位添加/编辑模态框 -->
        <div id="positionModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="hidePositionModal()">&times;</span>
                <h2 id="modalTitle">添加新岗位</h2>
                <form id="positionForm">
                    <input type="hidden" id="positionId" value="">
                    <div class="form-group">
                        <label for="positionTitle">职位名称</label>
                        <input type="text" id="positionTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="positionType">职位类型</label>
                        <select id="positionType" required>
                            <option value="技术研究">技术研究</option>
                            <option value="项目开发">项目开发</option>
                            <option value="社区">社区</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="positionDescription">职位描述</label>
                        <textarea id="positionDescription" rows="4" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="positionRequirements">要求（每行一个）</label>
                        <textarea id="positionRequirements" rows="4" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="positionResponsibilities">职责（每行一个）</label>
                        <textarea id="positionResponsibilities" rows="4" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">保存</button>
                </form>
            </div>
        </div>

        <!-- 项目表单模态框 -->
        <div id="projectModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeProjectModal()">&times;</span>
                <h2 id="projectModalTitle">添加新项目</h2>
                <form id="projectForm" onsubmit="handleProjectSubmit(event)">
                    <input type="hidden" id="projectId">
                    <div class="form-group">
                        <label for="projectTitle">项目名称</label>
                        <input type="text" id="projectTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="projectCategory">项目类别</label>
                        <input type="text" id="projectCategory" required placeholder="请输入项目类别">
                    </div>
                    <div class="form-group">
                        <label for="projectStatus">项目状态</label>
                        <select id="projectStatus" required>
                            <option value="进行中">进行中</option>
                            <option value="已完成">已完成</option>
                            <option value="规划中">规划中</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>项目内容</label>
                        <div id="projectBlocks" class="project-blocks">
                            <!-- 内容块将在这里动态添加 -->
                        </div>
                        <div class="block-actions">
                            <button type="button" onclick="addTextBlock()" class="action-button">添加文字</button>
                            <button type="button" onclick="addImageBlock()" class="action-button">添加图片</button>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="submit-button">保存</button>
                        <button type="button" onclick="closeProjectModal()" class="cancel-button">取消</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // 显示消息
        function showMessage(message, type = 'info') {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = message;
            messageDiv.className = type
            messageDiv.style.display = 'block';
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }

        // 检查登录状态
        function checkAuth() {
            const token = localStorage.getItem('adminToken');
            if (!token) {
                window.location.href = 'admin-login.html';
                return null;
            }
            return token;
        }

        // 处理表单提交
        document.getElementById('newsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const token = checkAuth();
            if (!token) return;

            try {
                // 创建 FormData 并打印内容
                const formData = new FormData();
                const title = document.getElementById('title').value;
                const content = document.getElementById('content').value;
                const imageInput = document.getElementById('image');
                
                const requestData = {
                    title: title,
                    content: content,
                    hasImage: imageInput.files.length > 0
                };
                console.log('准备发送的数据:', JSON.stringify(requestData, null, 2));

                formData.append('title', title);
                formData.append('content', content);
                
                if (imageInput.files[0]) {
                    const imageFile = imageInput.files[0];
                    const imageInfo = {
                        name: imageFile.name,
                        type: imageFile.type,
                        size: (imageFile.size / 1024).toFixed(2) + ' KB'
                    };
                    console.log('图片信息:', JSON.stringify(imageInfo, null, 2));
                    formData.append('image', imageFile);
                }

                // 检查 FormData 内容
                console.log('FormData 内容:');
                for (let pair of formData.entries()) {
                    console.log(pair[0] + ': ' + (pair[1] instanceof File ? pair[1].name : pair[1]));
                }

                console.log('开始发送请求...');
                console.log('使用的token:', token);
                
                const response = await fetch('/api/admin/news', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                console.log('服务器响应状态:', response.status);
                console.log('响应头:', Object.fromEntries(response.headers.entries()));
                
                const responseText = await response.text();
                console.log('服务器响应内容:', responseText);

                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    console.error('解析响应JSON失败:', e);
                    showMessage('服务器返回了非JSON格式的响应: ' + responseText.substring(0, 100), 'error');
                    return;
                }

                if (!response.ok) {
                    throw new Error(result.error || `服务器错误 (${response.status}): ${responseText}`);
                }

                if (result.success) {
                    showMessage('发布成功！', 'success');
                    this.reset();
                    document.getElementById('imagePreview').innerHTML = '';
                    loadNewsList();
                } else {
                    throw new Error(result.error || '发布失败，但未返回具体错误信息');
                }
            } catch (error) {
                console.error('发布错误:', error);
                showMessage('发布失败: ' + error.message, 'error');
            }
        });

        // 图片预览
        function previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    preview.innerHTML = `<img src="${e.target.result}" alt="预览图片">`;
                }
                reader.readAsDataURL(file);
            }
        }

        // 加载新闻列表
        async function loadNewsList() {
            const token = checkAuth();
            if (!token) return;

            try {
                const response = await fetch('/api/admin/news', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const news = await response.json();
                const newsListElement = document.getElementById('newsList');
                newsListElement.innerHTML = news.map(item => `
                    <div class="news-item">
                        <h3>${item.title}</h3>
                        <p>${item.content}</p>
                        ${item.image_url ? `<img src="${item.image_url}" alt="新闻图片" style="max-width: 200px;">` : ''}
                        <div class="news-meta">
                            <span>发布时间: ${new Date(item.date).toLocaleString()}</span>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('加载新闻列表失败:', error);
                showMessage('加载新闻列表失败: ' + error.message, 'error');
            }
        }

        // 退出登录
        function logout() {
            localStorage.removeItem('adminToken');
            window.location.href = 'admin-login.html';
        }

        // 切换标签页
        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });

            const selectedTab = document.querySelector(`.nav-tab:nth-child(${
                tabName === 'news' ? '1' : 
                tabName === 'positions' ? '2' : '3'
            })`);
            const selectedContent = document.getElementById(`${tabName}Tab`);
            
            selectedTab.classList.add('active');
            selectedContent.style.display = 'block';

            if (tabName === 'positions') {
                loadPositions();
            } else if (tabName === 'projects') {
                loadProjects();
            }
        }

        // 岗位管理相关函数
        async function loadPositions() {
            const token = checkAuth();
            if (!token) return;

            try {
                const response = await fetch('/api/admin/positions', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (data.success) {
                    displayPositions(data.positions);
                }
            } catch (error) {
                console.error('加载岗位列表失败:', error);
                showMessage('加载岗位列表失败: ' + error.message, 'error');
            }
        }

        function displayPositions(positions) {
            const container = document.getElementById('positionsList');
            container.innerHTML = positions.map(position => `
                <div class="position-item">
                    <div class="position-item-header">
                        <h3>${position.title}</h3>
                        <div class="position-actions">
                            <button class="btn btn-warning" onclick="editPosition(${position.id})">
                                <i class="fas fa-edit"></i> 编辑
                            </button>
                            <button class="btn btn-danger" onclick="deletePosition(${position.id})">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                        </div>
                    </div>
                    <p><strong>类型：</strong>${position.type}</p>
                    <p>${position.description}</p>
                    <div class="requirements">
                        <h4>要求：</h4>
                        <ul>
                            ${position.requirements.map(req => `<li>${req}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="responsibilities">
                        <h4>职责：</h4>
                        <ul>
                            ${position.responsibilities.map(resp => `<li>${resp}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `).join('');
        }

        function showPositionModal(position = null) {
            const modal = document.getElementById('positionModal');
            const form = document.getElementById('positionForm');
            const modalTitle = document.getElementById('modalTitle');

            modalTitle.textContent = position ? '编辑岗位' : '添加新岗位';
            
            if (position) {
                document.getElementById('positionId').value = position.id;
                document.getElementById('positionTitle').value = position.title;
                document.getElementById('positionType').value = position.type;
                document.getElementById('positionDescription').value = position.description;
                document.getElementById('positionRequirements').value = position.requirements.join('\n');
                document.getElementById('positionResponsibilities').value = position.responsibilities.join('\n');
            } else {
                form.reset();
                document.getElementById('positionId').value = '';
            }

            modal.style.display = 'block';
        }

        function hidePositionModal() {
            document.getElementById('positionModal').style.display = 'none';
        }

        async function editPosition(id) {
            const token = checkAuth();
            if (!token) return;

            try {
                const response = await fetch(`/api/admin/positions/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (data.success) {
                    showPositionModal(data.position);
                }
            } catch (error) {
                console.error('获取岗位详情失败:', error);
                showMessage('获取岗位详情失败: ' + error.message, 'error');
            }
        }

        async function deletePosition(id) {
            if (!confirm('确定要删除这个岗位吗？')) return;
            
            const token = checkAuth();
            if (!token) return;

            try {
                const response = await fetch(`/api/admin/positions/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (data.success) {
                    showMessage('岗位删除成功', 'success');
                    loadPositions();
                }
            } catch (error) {
                console.error('删除岗位失败:', error);
                showMessage('删除岗位失败: ' + error.message, 'error');
            }
        }

        // 岗位表单提交处理
        document.getElementById('positionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const token = checkAuth();
            if (!token) return;

            const id = document.getElementById('positionId').value;
            const position = {
                title: document.getElementById('positionTitle').value,
                type: document.getElementById('positionType').value,
                description: document.getElementById('positionDescription').value,
                requirements: document.getElementById('positionRequirements').value.split('\n').filter(Boolean),
                responsibilities: document.getElementById('positionResponsibilities').value.split('\n').filter(Boolean)
            };

            try {
                const response = await fetch(`/api/admin/positions${id ? `/${id}` : ''}`, {
                    method: id ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(position)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (data.success) {
                    showMessage(id ? '岗位更新成功' : '岗位添加成功', 'success');
                    hidePositionModal();
                    loadPositions();
                }
            } catch (error) {
                console.error('保存岗位失败:', error);
                showMessage('保存岗位失败: ' + error.message, 'error');
            }
        });

        // 项目管理相关函数
        function showAddProjectModal() {
            document.getElementById('projectModalTitle').textContent = '添加新项目';
            document.getElementById('projectForm').reset();
            document.getElementById('projectId').value = '';
            document.getElementById('projectBlocks').innerHTML = '';
            document.getElementById('projectModal').style.display = 'block';
        }

        function closeProjectModal() {
            document.getElementById('projectModal').style.display = 'none';
        }

        // 添加自动调整文本区域高度的函数
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        }

        function addTextBlock() {
            const blockDiv = document.createElement('div');
            blockDiv.className = 'project-block';
            blockDiv.innerHTML = `
                <textarea placeholder="请输入文字内容" oninput="autoResizeTextarea(this)"></textarea>
                <div class="block-controls">
                    <button type="button" class="block-control" onclick="moveBlockUp(this)">上移</button>
                    <button type="button" class="block-control" onclick="moveBlockDown(this)">下移</button>
                    <button type="button" class="block-control" onclick="removeBlock(this)">删除</button>
                </div>
            `;
            document.getElementById('projectBlocks').appendChild(blockDiv);
        }

        function addImageBlock() {
            const blockDiv = document.createElement('div');
            blockDiv.className = 'project-block';
            blockDiv.innerHTML = `
                <div class="image-upload-area" onclick="triggerFileInput(this)">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span>点击上传图片</span>
                    <input type="file" accept="image/*" onchange="handleImageUpload(this)" style="display: none;">
                </div>
                <div class="preview"></div>
                <div class="block-controls">
                    <button type="button" class="block-control" onclick="moveBlockUp(this)">上移</button>
                    <button type="button" class="block-control" onclick="moveBlockDown(this)">下移</button>
                    <button type="button" class="block-control" onclick="removeBlock(this)">删除</button>
                </div>
            `;
            document.getElementById('projectBlocks').appendChild(blockDiv);
        }

        function triggerFileInput(uploadArea) {
            const fileInput = uploadArea.querySelector('input[type="file"]');
            fileInput.click();
        }

        function moveBlockUp(button) {
            const block = button.closest('.project-block');
            const prev = block.previousElementSibling;
            if (prev) {
                block.parentNode.insertBefore(block, prev);
            }
        }

        function moveBlockDown(button) {
            const block = button.closest('.project-block');
            const next = block.nextElementSibling;
            if (next) {
                block.parentNode.insertBefore(next, block);
            }
        }

        function removeBlock(button) {
            const block = button.closest('.project-block');
            block.remove();
        }

        async function handleImageUpload(input) {
            const file = input.files[0];
            if (!file) return;

            // 验证文件大小（限制为5MB）
            if (file.size > 5 * 1024 * 1024) {
                alert('图片大小不能超过5MB');
                return;
            }

            const formData = new FormData();
            formData.append('image', file);

            try {
                const token = localStorage.getItem('adminToken');
                if (!token) {
                    throw new Error('未登录或登录已过期');
                }

                const response = await fetch('/api/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`上传失败: ${response.status}`);
                }

                const data = await response.json();
                if (data.success) {
                    const block = input.closest('.project-block');
                    const preview = block.querySelector('.preview');
                    const uploadArea = block.querySelector('.image-upload-area');
                    
                    preview.innerHTML = `
                        <img src="${data.url}" alt="已上传图片">
                        <input type="hidden" value="${data.url}">
                    `;
                    
                    // 隐藏上传区域
                    if (uploadArea) {
                        uploadArea.style.display = 'none';
                    }
                } else {
                    throw new Error(data.error || '上传失败');
                }
            } catch (error) {
                console.error('图片上传错误:', error);
                alert('图片上传失败: ' + error.message);
            }
        }

        async function handleProjectSubmit(event) {
            event.preventDefault();
            
            const token = localStorage.getItem('adminToken');
            if (!token) {
                alert('未登录或登录已过期');
                return;
            }
            
            const blocks = [];
            const blockElements = document.querySelectorAll('.project-block');
            
            blockElements.forEach(block => {
                const textarea = block.querySelector('textarea');
                const imageInput = block.querySelector('.preview input[type="hidden"]');
                
                if (textarea && textarea.value.trim()) {
                    blocks.push({
                        type: 'text',
                        content: textarea.value.trim()
                    });
                } else if (imageInput && imageInput.value) {
                    blocks.push({
                        type: 'image',
                        content: imageInput.value
                    });
                }
            });

            const projectData = {
                title: document.getElementById('projectTitle').value.trim(),
                category: document.getElementById('projectCategory').value.trim(),
                status: document.getElementById('projectStatus').value,
                blocks: blocks,
                date: new Date().toISOString()
            };

            const projectId = document.getElementById('projectId').value;
            const url = projectId ? 
                `/api/admin/projects/${projectId}` : 
                '/api/admin/projects';

            try {
                const response = await fetch(url, {
                    method: projectId ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(projectData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `操作失败: ${response.status}`);
                }

                const data = await response.json();
                closeProjectModal();
                loadProjects();
                showMessage(projectId ? '项目更新成功' : '项目添加成功', 'success');
            } catch (error) {
                console.error('项目保存错误:', error);
                showMessage('操作失败: ' + error.message, 'error');
            }
        }

        async function editProject(id) {
            try {
                const token = localStorage.getItem('adminToken');
                if (!token) {
                    throw new Error('未登录或登录已过期');
                }

                const response = await fetch(`/api/admin/projects/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (!data.project) {
                    throw new Error('未找到项目数据');
                }

                const project = data.project;
                document.getElementById('projectModalTitle').textContent = '编辑项目';
                document.getElementById('projectId').value = project.id;
                document.getElementById('projectTitle').value = project.title;
                document.getElementById('projectCategory').value = project.category || '';
                document.getElementById('projectStatus').value = project.status || '进行中';

                const blocksContainer = document.getElementById('projectBlocks');
                blocksContainer.innerHTML = '';

                if (project.blocks) {
                    project.blocks.forEach(block => {
                        if (block.type === 'text') {
                            const blockDiv = document.createElement('div');
                            blockDiv.className = 'project-block';
                            blockDiv.innerHTML = `
                                <textarea oninput="autoResizeTextarea(this)">${block.content}</textarea>
                                <div class="block-controls">
                                    <button type="button" class="block-control" onclick="moveBlockUp(this)">上移</button>
                                    <button type="button" class="block-control" onclick="moveBlockDown(this)">下移</button>
                                    <button type="button" class="block-control" onclick="removeBlock(this)">删除</button>
                                </div>
                            `;
                            blocksContainer.appendChild(blockDiv);
                        } else if (block.type === 'image') {
                            const blockDiv = document.createElement('div');
                            blockDiv.className = 'project-block';
                            blockDiv.innerHTML = `
                                <div class="preview">
                                    <img src="${block.content}" alt="项目图片">
                                    <input type="hidden" value="${block.content}">
                                </div>
                                <div class="block-controls">
                                    <button type="button" class="block-control" onclick="moveBlockUp(this)">上移</button>
                                    <button type="button" class="block-control" onclick="moveBlockDown(this)">下移</button>
                                    <button type="button" class="block-control" onclick="removeBlock(this)">删除</button>
                                </div>
                            `;
                            blocksContainer.appendChild(blockDiv);
                        }
                    });
                }

                document.getElementById('projectModal').style.display = 'block';
            } catch (error) {
                console.error('加载项目详情失败:', error);
                showMessage('加载项目详情失败: ' + error.message, 'error');
            }
        }

        async function deleteProject(id) {
            if (!confirm('确定要删除这个项目吗？')) return;

            try {
                const token = localStorage.getItem('adminToken');
                if (!token) {
                    throw new Error('未登录或登录已过期');
                }

                const response = await fetch(`/api/admin/projects/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                loadProjects();
                showMessage('项目删除成功', 'success');
            } catch (error) {
                console.error('删除项目失败:', error);
                showMessage('删除项目失败: ' + error.message, 'error');
            }
        }

        // 页面加载时检查认证并加载新闻列表
        document.addEventListener('DOMContentLoaded', function() {
            const token = checkAuth();
            if (token) {
                loadNewsList();
            }
        });

        async function loadProjects() {
            const token = localStorage.getItem('adminToken');
            if (!token) {
                window.location.href = '/admin-login.html';
                return;
            }

            try {
                const response = await fetch('/api/admin/projects', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('adminToken');
                        window.location.href = '/admin-login.html';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || '加载项目失败');
                }

                displayProjects(data.projects);
            } catch (error) {
                console.error('加载项目失败:', error);
                showMessage('加载项目失败: ' + error.message, 'error');
            }
        }

        function displayProjects(projects) {
            const projectsList = document.getElementById('projectsList');
            projectsList.innerHTML = projects.map(project => {
                // 查找第一张图片（如果有的话）
                const firstImage = project.blocks ? project.blocks.find(block => block.type === 'image') : null;
                const imageUrl = firstImage ? firstImage.content : '';
                
                return `
                    <div class="project-item">
                        <div class="project-title">${project.title}</div>
                        ${imageUrl ? `
                            <img src="${imageUrl}" 
                                 class="project-preview-image" 
                                 alt="${project.title}"
                                 onerror="this.onerror=null; this.src='images/placeholder.jpg';">
                        ` : ''}
                        <div class="project-info">
                            <span>类别：${project.category || '未分类'}</span>
                            <span>状态：${project.status || '未知'}</span>
                            <span>更新时间：${new Date(project.date).toLocaleString()}</span>
                        </div>
                        <div class="project-actions">
                            <button class="btn btn-warning" onclick="editProject(${project.id})">
                                <i class="fas fa-edit"></i> 编辑
                            </button>
                            <button class="btn btn-danger" onclick="deleteProject(${project.id})">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                            <a href="project-detail.html?id=${project.id}" class="btn btn-primary" target="_blank">
                                <i class="fas fa-eye"></i> 查看详情
                            </a>
                        </div>
                    </div>
                `;
            }).join('');
        }
    </script>
</body>
</html> 